# 性能测试

唯一稳定且可靠的性能度量是实际程序的执行时间，测试时间的对象一般使用合成的基准测试程序。测试获得时间后表述两个计算机的性能关系使用倍数描述：
$$
n = \frac{T_X}{T_Y}
$$
其中$T_X$为计算机X的执行时间，$T_Y$为计算机Y的执行时间，以上公式表述为“计算机Y的速度是计算机X的n倍”。在进行基准测试并生成报告时，需要坚持**可重现性**，即该测试结果可通过给出的参数定义完全重现。汇总结果时，有两种汇总方法：

- 直接取平均值或加权平均值
- 使用在基准计算机上测试的结果归一化，再取几何平均值

在基于归一化的情况下，两个计算机的性能比较如下公式所示，每个计算机的性能为基准计算机执行时间与该计算机执行时间之比。
$$
n = \frac{\frac{基准执行时间}{A执行时间}}{\frac{基准执行时间}{B执行时间}} = \frac{\frac{1}{A执行时间}}{\frac{1}{B执行时间}} = \frac{A性能}{B性能} =\frac{B执行时间}{A执行时间}
$$
由于比值是没有量纲的，因此在综合多个归一化结果时需要使用几何平均数。

# 性能提高

## 指导思想

计算机设计性能提高的指导思想有以下三点：

- 充分利用并行：在多个级别上进行并行处理，如指令级并行、流水线空间并行、多核处理器等等
- 局域性原理：局域性原理主要包括空间局域性和时间局域性，如下所示。优化的代表为cache。
  - 时间局域性：最近访问过的内容很可能会在短期内被再次访问
  - 空间局域性：地址相互临近的项目可能会在短期内被再次访问
- 终点关注常见情况：优化优先关注经常会发生的情况

## Amdahl定理

Amdahl可以计算通过改进计算机某一部分性能可获得的加速增益，首先定义加速比的概念如下所示：
$$
加速比=\frac{优化后某个任务对应的性能}{优化前某个任务对应的性能} = \frac{优化前任务的运行时间}{优化后任务的运行时间}
$$
对于一个指定的优化，其产生的加速比与以下两个因素有关：

- 升级比例：**原计算时间**中，该优化对应的可优化部分的占比。例如60s的任务中，有20s为该优化可优化的时间部分，则升级比例为$\frac{20}{60} = \frac{1}{3}$

- 升级加速比：使用该优化可实现的优化提升倍数。例如在20s为该优化可优化的时间部分，应用该优化后可将时间缩短为2s，则升级加速比为$\frac{20}{2} = 10$倍

对于任意一个优化，应用优化后的新执行时间如下公式所示：
$$
新执行时间 = 原执行时间 \times [(1-升级比例) + 升级比例 \times \frac{现计算时间}{原计算时间}] \\ = 原执行时间 \times [(1-升级比例) +  \frac{升级比例}{升级加速比}]
$$
由上可以计算总加速比（Amdahl定理）：
$$
总加速比 = \frac{原执行时间}{新执行时间} = \frac{1}{(1-升级比例) +  \frac{升级比例}{升级加速比}}
$$
Amdahl定理表明了如果仅改进一部分计算性能，则在增加改进时，所获得的加速比增量会逐渐减小。

## 处理器性能评估

处理器性能的评估指标为CPI（每条指令时钟周期数），即执行一条指令平均需要花费的时钟周期数量，其定义如下公式：
$$
CPI = \frac{程序消耗的CPU时钟周期数}{程序的指令数}
$$
这里需要注意的是，这里的判断工具为程序，而不是制定数量的指令，一个程序对应的指令数与指令集和编译器技术有关。定义一个程序的指令数为IC，则运行一个程序的CPU时间为：
$$
CPU时间 = IC \times CPI \times CPU时钟周期
$$
从以上公式看，想要优化处理器在处理某个任务上的时间，需要考虑：

- 时钟周期数：与工艺和电路设计强相关
- CPI：处理器结构和指令体系结构有关
- 指令数IC：指令体系结构和编译器技术有关